let packageName="bitmap-font",fs=require("fire-fs"),path=require("fire-path");var Electron=require("electron"),CfgUtil=Editor.require("packages://bitmap-font/core/CfgUtil");let charItem=Editor.require("packages://"+packageName+"/panel/item/item.js");window.dc=Editor.require("packages://"+packageName+"/core/dcagent.js"),Editor.Panel.extend({style:fs.readFileSync(Editor.url("packages://"+packageName+"/panel/index.css","utf8"))+"",template:fs.readFileSync(Editor.url("packages://"+packageName+"/panel/index.html","utf8"))+"",$:{logTextArea:"#logTextArea",view:"#view",container:"#container",section:"#section"},ready(){window.dc.init({appId:"C4BD3340E6AD9B1BDF5B8DCE466BAF694",channel:cc.sys.os});let e=this.$logTextArea,t=this.$view,a=this.$container,i=this.$section,r=function(){a&&t&&a.scrollHeight<t.clientHeight&&(i.style.height=t.clientHeight-30+"px",a.style.height=t.clientHeight-15+"px")};charItem.init(),window.addEventListener("resize",function(){r()}),window.plugin=new window.Vue({el:this.shadowRoot,created(){this._initPlugin(),r()},init(){},data:{isLoadCfgProject:!0,uuid:null,logView:[],fileSavePath:null,fileSaveName:null,fileImportPath:null,charDataArray:[],cfgArray:["fsfsfe"]},methods:{onAddCfg(){this.cfgArray.push("32132423")},onCfgSelectChange(e,t,a){e.currentTarget.value},onBtnClickTest(){let e=path.join(Editor.projectInfo.path,"packages/bitmap-font/panel/index.js"),t=path.join(Editor.projectInfo.path,"packages/bitmap-font/panel/index.min.js");if(!fs.existsSync(e))return void this._addLog("文件不存在: "+e);let a=fs.readFileSync(e,"utf-8"),i=Editor.require("packages://bitmap-font/node_modules/uglify-es").minify(a);i.error?this._addLog("生成压缩代码失败"):(this._addLog(i.code),fs.writeFileSync(t,i.code))},_addLog(t){let a=new Date;this.logView+="["+a.toLocaleString()+"]: "+t+"\n",setTimeout(function(){e.scrollTop=e.scrollHeight},10)},delAllCharCfg(){this.charDataArray.splice(0,this.charDataArray.length),CfgUtil.saveConfig(),this._addLog("清空配置成功!")},delCharCfg(e){if(!e)return void this._addLog("删除失败");let t=!1;for(let a=0;a<this.charDataArray.length;a++){let i=this.charDataArray[a];i.image===e.image&&i.imageWidth===e.imageWidth&&i.imageHeight===e.imageHeight&&(this.charDataArray.splice(a,1),this._addLog("del: "+i.image),t=!0)}t&&CfgUtil.saveConfig()},_initTestData(){this._addImage("C:/project/client/cargame/packages/bitmap-font/image/3.png","3"),this._addImage("C:/project/client/cargame/packages/bitmap-font/image/0.png","0")},_initPlugin(){CfgUtil.initCfg(function(e){this._initTmpDir(),e&&(this.fileSaveName=e.saveName,this.fileImportPath=e.saveImport,this.charDataArray=e.bitMapCfg||[],this.charDataArray.sort(function(e,t){let a=e.image,i=t.image,r=path.basename(a),n=path.basename(i);return r.charCodeAt(0)-n.charCodeAt(0)}))}.bind(this))},_initTmpDir(){let e=Electron.remote.app.getPath("userData"),t=path.join(e,"/bitmap-font");fs.existsSync(t)||fs.mkdirSync(t),this.fileSavePath=t},onWinResize(){this.$nextTick(function(){let e=this.$el.ownerDocument.getElementsByClassName("fit").namedItem("bitmap-font");e&&(e.onresize=function(){})})},onClickOpen(){this.fileSavePath&&(Electron.shell.showItemInFolder(this.fileSavePath),Electron.shell.beep())},onClickSelect(){let e=Editor.Dialog.openFile({title:"选择保存目录",defaultPath:Editor.projectInfo.path,properties:["openDirectory"]});if(-1!==e){let t=e[0];this.fileSavePath=t,CfgUtil.setSavePath(t)}},onUpdateSaveName(e){if(this.fileSaveName){if(new RegExp('^[^\\\\\\/:*?\\"<>|]+$').test(this.fileSaveName)){if(-1!==this.fileSaveName.indexOf(".")){let e=this.fileSaveName.split(".");this._addLog(this.fileSaveName+"不需要包含扩展名,已经自动修改为:"+e[0]),this.fileSaveName=e[0]}CfgUtil.setSaveName(this.fileSaveName)}else this._addLog("文件名不符合规则:"+this.fileSaveName),this.fileSaveName=""}else 0===this.fileSaveName.length&&this._addLog("保存文件名不能为空")},onSelectImportPath(){let e=Editor.Dialog.openFile({title:"选择导出目录",defaultPath:Editor.projectInfo.path,properties:["openDirectory"]});if(-1!==e){let t=e[0],a=Editor.assetdb.remote.fspathToUrl(t);-1===a.indexOf("db://")?(this._addLog("不是项目资源目录:"+t),this.fileImportPath=""):(this.fileImportPath=a,CfgUtil.setSaveImport(a))}},onGenAndImportFont(){Editor.assetdb.queryInfoByUuid(this.uuid,function(e,t){if(e)this._addLog(e);else{let e=t.path,a=path.dirname(e),i=path.basename(e,".fnt");this.onGen(i,function(){this._addLog("导入bitmap-font到项目!");let e=Editor.assetdb.remote.fspathToUrl(a);setTimeout(function(){this.onImport(i,e)}.bind(this),500)}.bind(this))}}.bind(this))},onImportFont(){this.onImport(this.fileSaveName,this.fileImportPath)},onImport(e,t){if(!t)return void this._addLog("导出目录错误:"+t);let a=path.join(this.fileSavePath,e+".png");if(!fs.existsSync(a))return void this._addLog("fnt图片文件不存在:"+a);let i=path.join(this.fileSavePath,e+".fnt");if(!fs.existsSync(i))return void this._addLog("fnt字体文件不存在:"+i);Editor.assetdb.import([a,i],t,!0,function(e,a){this._addLog("导入成功!"),Editor.assetdb.refresh(t),a.forEach(function(e,t,a){})}.bind(this))},onGen(e,t){if(!this.fileSavePath||!fs.existsSync(this.fileSavePath))return void this._addLog("文件保存目录不存在: "+this.fileSavePath);let a=this._checkAllCharValueIsSet();if(a)return void this._addLog("该图片没有设置字符: "+a.image);if(this.charDataArray.length<=0)return void this._addLog("请导入图片!");let i=[];for(let e=0;e<this.charDataArray.length;e++)i.push(this.charDataArray[e].image);this._addLog("生成中..."),Editor.require("packages://bitmap-font/node_modules/spritesmith").run({src:i,algorithm:"binary-tree"},function(a,i){if(a);else{let a=path.join(this.fileSavePath,e+".png");fs.writeFileSync(a,i.image);let r=require("util"),n='info face="微软雅黑" size=40 bold=0 italic=0 charset="" unicode=1 stretchH=100 smooth=1 aa=1 padding=0,0,0,0 spacing=1,1 outline=0\n',h=r.format("common lineHeight=40 base=26 scaleW=%d scaleH=%d pages=1 packed=0 alphaChnl=1 redChnl=0 greenChnl=0 blueChnl=0\n",i.properties.width,i.properties.height),s=r.format('page id=0 file="%s.png"\n',e),o=r.format("chars count=%d\n",this.charDataArray.length),l="";for(let e in i.coordinates){let t=this._setCharData(e,i.coordinates[e]);if(!t)return this._addLog("该图片没有设置字符: "+e),void this._addLog("生成font字体失败!");l+=t}let d=n+h+s+o+l,f=path.join(this.fileSavePath,e+".fnt");fs.writeFileSync(f,d),this._addLog("生成成功, 文件保存在:"+f),t&&t()}}.bind(this))},onClickGen(){this.onGen(this.fileSaveName)},_checkAllCharValueIsSet(){for(let e=0;e<this.charDataArray.length;e++){let t=this.charDataArray[e];if(null===t.char)return t;if(""===t.char)return t}return null},checkIsContentRepeatChar(e){let t=[];for(let a=0;a<this.charDataArray.length;a++){let i=this.charDataArray[a];i.char===e&&t.push(i)}if(t.length>1){let a=require("util").format("发现多张图片对应同一个字符[%s] :\n",e);for(let e=0;e<t.length;e++)a+=t[e].image+"\n";return this._addLog(a),!0}return!1},_setCharData(e,t){let a=require("util"),i=null;for(let t=0;t<this.charDataArray.length;t++){let a=this.charDataArray[t];if(a.image===e){i=a.char;break}}if(i&&1===i.length){let e=i.charCodeAt(0);return a.format("char id=%d   x=%d    y=%d     width=%d    height=%d    xoffset=0     yoffset=0     xadvance=%d    page=0  chnl=15\n",e,t.x,t.y,t.width,t.height,t.width)}return this._addLog("没有发现字符"),null},drop(e){e.preventDefault();for(let t=0;t<e.dataTransfer.files.length;t++){let a=e.dataTransfer.files[t],i=a.path;if("image/png"===a.type)if(this._isSameFileExist(i))this._addLog("已经存在该图片: "+i);else{let e=path.basenameNoExt(i)[0]||null;this._addImage(i,e)}else this._addLog("只能识别图片: "+i)}return CfgUtil.saveConfig(),!1},_addImage(e,t){let a=require(Editor.url("packages://bitmap-font/node_modules/image-size"))(e),i={image:e,char:t,imageWidth:a.width,imageHeight:a.height};this.charDataArray.push(i),this.charDataArray.sort(function(e,t){let a=e.image,i=t.image,r=path.basename(a).toLowerCase(),n=path.basename(i).toLowerCase(),h=r.length>n.length?n.length:r.length,s=0;for(let e=0;e<h;e++)if(r.charCodeAt(e)!==n.charCodeAt(e)){s=e;break}return r.charCodeAt(s)-n.charCodeAt(s)}),CfgUtil.setBitmapCfg(this.charDataArray)},_isSameFileExist(e){let t=!1;for(let a=0;a<this.charDataArray.length;a++)if(this.charDataArray[a].image===e){t=!0;break}return t},dragOver(e){e.preventDefault(),e.stopPropagation()},dragEnter(e){e.preventDefault(),e.stopPropagation()},dragLeave(e){e.preventDefault()}}})},messages:{"bitmap-font:onClickDelChar"(e,t){window.plugin.delCharCfg(t)},"bitmap-font:onClickDelAllChar"(e,t){window.plugin.delAllCharCfg(t)}}});